{% extends 'base.html' %}
{% load static %}
{% block content %}

    <h1>Realtime Detection</h1>

    <img id="video" src="" alt="Video streaming">
    <br>
    <button id="start-btn">Start</button>
    <button id="stop-btn">Stop</button>
    <table class="table">
      <thead>
        <tr>
          <th scope="col">#</th>
          <th scope="col">Feelings</th>
          <th scope="col">Count</th>
          <th scope="col">ETC</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <th scope="row">1</th>
          <td>anger</td>
          <td id="anger">0</td>
          <td>@mdo</td>
        </tr>
        <tr>
          <th scope="row">2</th>
          <td>anxiety</td>
          <td id="anxiety">0</td>
          <td>@fat</td>
        </tr>
        <tr>
          <th scope="row">3</th>
          <td>embarrassed</td>
          <td id="embarrassed"></td>
          <td>@twitter</td>
        </tr>
        <tr>
          <th scope="row">4</th>
          <td>hurt</td>
          <td id="hurt">0</td>
          <td>@twitter</td>
        </tr>
        <tr>
          <th scope="row">5</th>
          <td>neutral</td>
          <td id="neutral">0</td>
          <td>@twitter</td>
        </tr>
        <tr>
          <th scope="row">6</th>
          <td>pleasure</td>
          <td id="pleasure">0</td>
          <td>@twitter</td>
        </tr>
        <tr>
          <th scope="row">7</th>
          <td>sad</td>
          <td id="sad">0</td>
          <td>@twitter</td>
        </tr>

      </tbody>
    </table>




    <script>
        const video = document.getElementById('video');
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const anger= document.getElementById('anger')
        const anxiety= document.getElementById('anxiety')
        const embarrassed= document.getElementById('embarrassed')
        const hurt= document.getElementById('hurt')
        const neutral= document.getElementById('neutral')
        const pleasure= document.getElementById('pleasure')
        const sad= document.getElementById('sad')




        let socket;
      
        function createWebSocket() {
          socket = new WebSocket('ws://' + window.location.host + '/ws/video/');
      
          socket.onopen = function(event) {
            console.log('WebSocket opened:', event);
          };
      
          socket.onmessage = function(event) {
            data=JSON.parse(event.data)
            const imageBase64 = data['image'];
            const feelings = data['feelings'];
            
            anger.innerText= feelings['anger'];
            anxiety.innerText= feelings['anxiety'];
            embarrassed.innerText= feelings['embarrassed'];
            hurt.innerText= feelings['hurt'];
            neutral.innerText= feelings['neutral'];
            pleasure.innerText= feelings['pleasure'];
            sad.innerText= feelings['sad'];




            video.src = 'data:image/jpeg;base64,' + imageBase64;
          };
      
          socket.onclose = function(event) {
            console.log('WebSocket closed:', event);
            if (!event.wasClean) {
              setTimeout(createWebSocket, 1000);
            }
          };
        }
      
        createWebSocket();
      
        startBtn.addEventListener('click', () => {
          if (!socket || socket.readyState === WebSocket.CLOSED) {
            createWebSocket();
          }
          setTimeout(() => {
            socket.send('start');
          }, 500);
        });
      
        stopBtn.addEventListener('click', () => {
          if (socket && socket.readyState === WebSocket.OPEN) {
            console.log(socket.readyState)
            socket.send('stop');
            socket.close(1000);
          
          }
        });
      
        window.onbeforeunload = function() {
          if (socket && socket.readyState === WebSocket.OPEN) {
            socket.send('stop');
          }
        };
    </script>
        
{% endblock %}
